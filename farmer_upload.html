<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Agrofy - Farmer Upload</title>
<link rel="stylesheet" href="style.css" />
</head>
<body>

<header class="navbar">
  <div class="navbar-logo" onclick="window.location.href='index.html'">
    <img src="logo.jpeg" alt="Agrofy Logo" />
    <span>Agrofy</span>
  </div>
  <nav class="navbar-links">
    <a href="index.html" data-i18="home">Home</a>
    <a href="products.html" data-i18="products">Products & Services</a>
    <a href="contact.html" data-i18="contact">Contact</a>
    <a href="login.html" id="loginLink" data-i18="loginBtn">Login</a>
    <a href="register.html" id="registerLink" data-i18="registerNow">Register</a>
  </nav>
</header>

<div class="container">
  <h2 data-i18="uploadTitle">ðŸ“¤ Upload Your Product or Service</h2>

  <form id="uploadForm" style="max-width:600px;margin:0 auto;">
    <input type="text" id="productName" data-i18-placeholder="productName" placeholder="Product/Service Name" required />

    <select id="productType" required>
      <option value="" data-i18="selectType">-- Select Type --</option>
      <option value="Product" data-i18="productOption">Product</option>
      <option value="Service" data-i18="serviceOption">Service</option>
    </select>

    <textarea id="description" data-i18-placeholder="description" placeholder="Description" required></textarea>

    <input type="number" id="price" data-i18-placeholder="price" placeholder="Price (â‚¹)" required />
    <input type="number" id="quantity" data-i18-placeholder="quantity" placeholder="Quantity" required />

    <input type="file" id="imgInput" accept="image/*" required data-i18-placeholder="imageUpload" />
    <img id="imgPreview" style="max-width:100%;margin-top:12px;display:none;border-radius:12px;" />

    <pre id="uploadOutput"></pre>

    <button type="submit" data-i18="uploadBtn">Upload for Verification</button>
  </form>
</div>


<script src="userStatus.js"></script>
<script>
const PRODUCT_API = "https://script.google.com/macros/s/AKfycbwAGJsclDN5hMGjQrudkgFbvTwFQMOjzuHWHQaUOZbU7N3wwmLzjbUh51QJXDADmB4qNA/exec";
const cloudName = 'dnqrx3gny';
const uploadPreset = 'agrofy_upload';

if (localStorage.getItem('userType') !== 'farmer' || localStorage.getItem('verified') !== 'yes') {
  alert('Access denied. Only verified farmers can upload.');
  window.location.href = 'index.html';
}

const imgInput = document.getElementById('imgInput');
const imgPreview = document.getElementById('imgPreview');
const uploadOutput = document.getElementById('uploadOutput');

imgInput.addEventListener('change', async e => {
  const file = e.target.files[0];
  if (!file) return;

  uploadOutput.textContent = "Uploading image to Cloudinary...";

  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', uploadPreset);

  try {
    const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/upload`, {
      method: 'POST',
      body: formData
    });
    const data = await res.json();
    uploadedImageURL = data.secure_url;
    imgPreview.src = uploadedImageURL;
    imgPreview.style.display = 'block';
    uploadOutput.textContent = "Image uploaded successfully!";
  } catch(err) {
    uploadOutput.textContent = "Cloudinary upload failed: " + err.message;
  }
});

document.getElementById('uploadForm').onsubmit = async (e) => {
  e.preventDefault();
  const name = document.getElementById('productName').value.trim();
  const type = document.getElementById('productType').value;
  const desc = document.getElementById('description').value.trim();
  const price = document.getElementById('price').value.trim();
  const qty = document.getElementById('quantity').value.trim();
  const images = uploadedImageURL || '';
  const userName = localStorage.getItem("loggedInUser") || "Unknown";
  const userEmail = localStorage.getItem("loggedInEmail") || "";

  if (!name || !type || !desc || !price || !qty || !images) {
    alert('Please fill all fields and upload an image');
    return;
  }

  const params = new URLSearchParams({
  action: 'addProduct',
  name,
  type,
  description: desc,
  price,
  quantity: qty,
  images,
  userName,
  userEmail, // âœ… Add this line
  verified: 'no'
});


  try {
    const data = await jsonpCall(`${PRODUCT_API}?${params.toString()}`, 'handleUploadResponse');
    if (data.status === 'success') {
      alert('Product uploaded for verification');
      window.location.href = 'index.html';
    } else {
      alert('Error: ' + data.message);
    }
  } catch {
    alert('Upload failed');
  }
};

function jsonpCall(url, callbackName) {
  return new Promise((resolve, reject) => {
    window[callbackName] = (data) => {
      resolve(data);
      delete window[callbackName];
      script.remove();
    };
    const script = document.createElement('script');
    script.src = `${url}&callback=${callbackName}`;
    script.onerror = () => reject(new Error('JSONP request failed'));
    document.body.appendChild(script);
  });
}
</script>
<footer class="footer">
  <div class="footer-container">
    <div class="footer-about">
      <h3 data-i18="footerAboutTitle">About Agrofy</h3>
      <p data-i18="footerAboutText">
        Agrofy connects farmers, buyers, and transporters for seamless trade of fresh agricultural products and services.
      </p>
    </div>

    <div class="footer-links">
      <h3 data-i18="footerQuickLinks">Quick Links</h3>
      <ul>
        <li><a href="contact.html" data-i18="contact">Contact</a></li>
        <li><a href="faq.html" data-i18="faq">FAQ</a></li>
      </ul>
    </div>

    <div class="footer-social">
      <h3 data-i18="footerFollowUs">Follow Us</h3>
      <div class="social-icons">
        <a href="https://facebook.com" target="_blank"><img src="https://cdn-icons-png.flaticon.com/128/1384/1384005.png" alt="Facebook" /></a>
        <a href="https://twitter.com" target="_blank"><img src="https://cdn-icons-png.flaticon.com/128/5969/5969020.png" alt="Twitter" /></a>
        <a href="https://instagram.com" target="_blank"><img src="https://cdn-icons-png.flaticon.com/128/3955/3955024.png" alt="Instagram" /></a>
        <a href="https://youtube.com" target="_blank"><img src="https://cdn-icons-png.flaticon.com/128/3670/3670147.png" alt="YouTube" /></a>
      </div>
    </div>
  </div>

  <div class="footer-bottom">
    <p>&copy; <span id="year"></span> Agrofy. <span data-i18="footerRights">All rights reserved.</span></p>
  </div>
</footer>

<script>
document.getElementById("year").textContent = new Date().getFullYear();
</script>
</body>
</html>
